
$('head').append(
    '<style>' +
    ".t-search-result-wraper {z-index:9999;list-style-type: none;position: absolute; padding: 20px 0px !important;box-shadow: 0px 2px 10px rgba(0,0,0,0.1);border: 1px solid rgba(0,0,0,0.05); background-color: rgba(255,255,255,1); width: 100%}" +
    ".t-search-result{padding: 10px 20px;}" +
    ".t-search-result a{color: #111 !important; font-family: 'TildaSans', 'tfutura', sans-serif !important; text-decoration:}" +
    ".t-search-result:hover{background-color: #ebebeb;}" +
    "@keyframes rotate360 {\n" +
    "  to { transform: rotate(360deg); }\n" +
    "}" +
    ".t-search-result b{font-weight:500;}" +
    ".t-searcher-popup-bg{width: 100%; height: 100%; background-color: rgba(238, 238, 238, 0.97); display: block; vertical-align: top; z-index:3500;top:0;left:0;position:fixed; overflow: scroll;}" +
    ".t-searcher-popup{width: 740px;margin: 40px auto;background: #fff;overflow-x: scroll; border-radius: 10px;box-shadow: 0px 2px 12px rgba(0,0,0,0.07);}" +
    ".singl{ margin-bottom: 40px;font-size: 20px;font-family: 'TildaSans', 'tfutura',Arial; font-weight: 100; line-height: 1.3;}" +
    ".singl img{width: 100%; padding-bottom: 26px;}" +
    ".singl ol{padding-bottom: 25px}" +
    ".singl p{padding-bottom: 26px}" +
    ".singl a{color: rgba(250, 134, 105, 1) !important;}" +
    ".t-searcher-popup-wraper{padding: 40px;    margin-bottom: 0px;}" +
    '</style>'
);

var timerID = 0;
var anim = 0;

$('.t-searcher').on('input', function() {
    if( timerID > 0) {clearTimeout(timerID);}
    timerID = setTimeout(function(){
        if (anim == 0) {
            $('.t-searcher-close').css('display', 'none');
            $('.t-searcher-load').css('display', 'block');
            $('.t-searcher-load-img').css('animation', '2s rotate360 infinite linear');
            anim = 1;
        }
        request();
    },700)
});

$('.t-searcher-close').on('click',function () {
    $('.t-search-result-wraper').detach();
    $('.t-searcher').val('');
    $('.t-searcher-close').css('display','none');
});



function searchResult(data){
    var input = $('.t-searcher');
    var lang = $('.t-searcher').attr('data-attr-lang');
    if(lang == 'RU'){lang = 'ru'}
    else {lang = 'en'}
    $('.t-search-result-wraper').detach();
    var html = "<div><ul class='t-search-result-wraper'>";
    $.each( data, function( key, value ) {
        if(key != 'meta') {
            html += '<li class="t-search-result">' +
                '<a class="t-searcher-popup-link" data-result-id="' + value[0].id + '" style="width: 100%; display: block;" href="#' + value[0].alias + '">'
                + value[0].quest + '</a></li>';
        }
    });
    html += "</ul></div>";
    input.after(html);
}

$(document).keydown(function(eventObject){
    if($('.t-searcher-popup-bg').length) {
        if (eventObject.which == 27) {
            history.pushState('', document.title, window.location.pathname);
            $('.t-searcher-popup-bg').detach();
        };
    }
});

$(document).on('click','.t-searcher-popup-link',function () {
    var id = $(this).attr('data-result-id');
    $.ajax({
        type: "GET",
        url:"https://answers.tilda.cc/api/answer/get/"+id,
        success: function(data){
            showPopup(data);
        },
        error: function (data) {
            //console.log(data);
        }
    });
    $('.t-search-result-wraper').detach();
});

$(document).on('click','.t-searcher-popup-close',function () {
    history.pushState('', document.title, window.location.pathname);
    console.log(window.location.pathname);
    $('.t-searcher-popup-bg').detach();
});

function showPopup(data) {
    $('.t-searcher-popup-bg').detach();
    html =
        "<div class='t-searcher-popup-bg'>" +
            "<div class=\"t-searcher-popup-close\" style=\"cursor: pointer;position: absolute;right:30px;top:30px;width: 30px;height:30px;\">" +
            "<img class=\"t-searcher-popup-close-img\" style=\" opacity: 0.5; height: 100%\" src=\"//answers.tilda.cc/src/images/tp-08-close.svg\">" +
            "</div>" +
            "<div class='t-searcher-popup'>" +
                "<div class='t-searcher-popup-wraper singl'>" +
                    "<h3 style='padding-bottom: 30px'>" +
                        data.quest +
                    "</h3>" +
                    "<div class='t-searcher-popup-answer'>" +
                        data.answer +
                    "</div> " +
                "</div>" +
            "</div>" +
        "</div>";
    $('body').append(html);
    var id = data.id;
    var cookie = getCookie('answr'+data.id);
    if(typeof cookie === "undefined") {
        //console.log('q');
        $.ajax({
            type: "GET",
            url: "https://answers.tilda.cc/api/counter/view/" + id,
            success: function (data) {
                document.cookie = 'answr'+id+'=true';
            },
            error: function (data) {
            }
        });
    }
}

function getCookie(name) {
    var matches = document.cookie.match(new RegExp(
        "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
    ));
    return matches ? decodeURIComponent(matches[1]) : undefined;
}

function request() {
    var query = $('.t-searcher').val();
    query = query.split('#').join('');
    query = query.split('&').join('');
    var lang = $('.t-searcher').attr('data-attr-lang');
    //console.log(lang+' dddd');
    if(query.length > 2 && query.length < 80){
        $.ajax({
            type: "GET",
            url:"https://answers.tilda.cc/api/search?q="+query+'&lang='+lang.toLowerCase(),
            success: function(data){
                $('.t-search-result-wraper').detach();
                if(data.length>0) {
                    if(anim == 1){
                        $('.t-searcher-load-img').css({'animation':''});
                        $('.t-searcher-load').css('display','none');
                        $('.t-searcher-close').css('display','block');
                        anim =0;
                    }
                    searchResult(data);
                } else {
                    $('.t-searcher-load').css('display','none');
                    $('.t-searcher-load-img').css({'animation':''});
                    $('.t-searcher-close').css('display','none');
                }
            },
            error: function () {
            }
        });
    } else {
        $('.t-search-result-wraper').detach();
        $('.t-searcher-close').css('display','none');
        $('.t-searcher-load').css('display','none');
        $('.t-searcher-load-img').css({'animation':''});
    }
}
